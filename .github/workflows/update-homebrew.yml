name: Update Homebrew Formula

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update (e.g., 0.4.0)'
        required: true
        type: string

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout homebrew-mcpx
        uses: actions/checkout@v5
        with:
          repository: AIGC-Hackers/homebrew-mcpx
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Extract version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Download release assets
        run: |
          VERSION=${{ steps.version.outputs.version }}
          mkdir -p downloads
          cd downloads

          echo "Downloading tar.gz packages for v$VERSION..."
          curl -sL "https://github.com/AIGC-Hackers/mcpx/releases/download/v$VERSION/mcpx-darwin-arm64.tar.gz" -o mcpx-darwin-arm64.tar.gz
          curl -sL "https://github.com/AIGC-Hackers/mcpx/releases/download/v$VERSION/mcpx-linux-arm64.tar.gz" -o mcpx-linux-arm64.tar.gz
          curl -sL "https://github.com/AIGC-Hackers/mcpx/releases/download/v$VERSION/mcpx-linux-x64.tar.gz" -o mcpx-linux-x64.tar.gz

          ls -lh

      - name: Calculate checksums
        id: checksums
        run: |
          cd downloads
          echo "darwin_arm64=$(shasum -a 256 mcpx-darwin-arm64.tar.gz | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "linux_arm64=$(shasum -a 256 mcpx-linux-arm64.tar.gz | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "linux_x64=$(shasum -a 256 mcpx-linux-x64.tar.gz | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Update formula
        run: |
          VERSION=${{ steps.version.outputs.version }}

          cat > Formula/mcpx.rb << EOF
          # ⚠️  AUTO-GENERATED - DO NOT EDIT MANUALLY!
          # This file is generated by CI. Manual edits will be overwritten.
          # To update: See CLAUDE.md or trigger update-homebrew.yml workflow
          class Mcpx < Formula
            desc "Extended TypeScript runtime and CLI for Model Context Protocol"
            homepage "https://github.com/AIGC-Hackers/mcpx"
            version "$VERSION"
            license "MIT"

            on_macos do
              url "https://github.com/AIGC-Hackers/mcpx/releases/download/v$VERSION/mcpx-darwin-arm64.tar.gz"
              sha256 "${{ steps.checksums.outputs.darwin_arm64 }}"
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/AIGC-Hackers/mcpx/releases/download/v$VERSION/mcpx-linux-arm64.tar.gz"
                sha256 "${{ steps.checksums.outputs.linux_arm64 }}"
              else
                url "https://github.com/AIGC-Hackers/mcpx/releases/download/v$VERSION/mcpx-linux-x64.tar.gz"
                sha256 "${{ steps.checksums.outputs.linux_x64 }}"
              end
            end

            def install
              bin.install "mcpx"
              zsh_completion.install "completions/_mcpx"
              bash_completion.install "completions/mcpx.bash" => "mcpx"
              fish_completion.install "completions/mcpx.fish"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/mcpx --version")
            end
          end
          EOF

          echo "Formula updated:"
          cat Formula/mcpx.rb

      - name: Commit and push
        run: |
          VERSION=${{ steps.version.outputs.version }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/mcpx.rb
          git commit -m "chore: update to v$VERSION"
          git push
